<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive Panel - Account-Einstellungen</title>
    
    <!-- CRITICAL: Dark Mode BEFORE CSS loading -->
    <script>
        (function() {
            const darkMode = localStorage.getItem('hive-panel-dark-mode') === 'true';
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêù</text></svg>">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="sidebar-title">Hive Panel</span>
                </div>
                <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
                    <i data-lucide="panel-left-close"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/dashboard.html" class="sidebar-item">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/html/admin/accounts.html" class="sidebar-item" data-permission="manage_accounts,view_accounts,admin_all,*" style="display: none;">
                    <i data-lucide="users-cog"></i>
                    <span>Account-Verwaltung</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button id="sidebar-account-button" class="sidebar-item sidebar-account active">
                    <i data-lucide="user-circle"></i>
                    <span id="sidebar-username-display"></span>
                </button>
                <button id="sidebar-logout-button" class="sidebar-item sidebar-logout">
                    <i data-lucide="log-out"></i>
                    <span>Abmelden</span>
                </button>
            </div>
        </aside>
        
        <!-- Mobile Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>
        
        <!-- Main Content -->
        <div class="main-wrapper">
            <header class="dashboard-header">
                <div class="header-content">
                    <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle Menu">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="header-right">
                    </div>
                </div>
            </header>
        
            <main class="dashboard-main">
                <div class="dashboard-content">
                    <div class="dashboard-card">
                        <h2><i data-lucide="user-cog" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle;"></i> Account-Einstellungen</h2>
                        <p>Verwalten Sie Ihre Account-Informationen und Sicherheitseinstellungen.</p>
                    </div>
                    
                    <div class="account-settings-grid">
                        <!-- Username Change -->
                        <div class="dashboard-card">
                            <h3><i data-lucide="user" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i> Benutzername √§ndern</h3>
                            <div class="form-group">
                                <label>Aktueller Benutzername</label>
                                <div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--color-bg-secondary); border: 1px solid var(--color-border); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
                                    <strong id="current-username-display">Wird geladen...</strong>
                                </div>
                            </div>
                            <button type="button" id="edit-username-btn" class="btn btn-secondary" style="margin-bottom: var(--spacing-sm);">
                                <i data-lucide="edit"></i>
                                <span>Benutzername bearbeiten</span>
                            </button>
                            <form id="username-form" class="account-form" style="display: none;">
                                <div class="form-group">
                                    <label for="new-username">Neuer Benutzername</label>
                                    <input type="text" id="new-username" name="newUsername" required 
                                           placeholder="Neuer Benutzername"
                                           pattern="[a-zA-Z0-9_-]+"
                                           minlength="3"
                                           maxlength="30">
                                    <small class="form-help">3-30 Zeichen, nur Buchstaben, Zahlen, _ und -</small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save"></i>
                                        <span>Speichern</span>
                                    </button>
                                    <button type="button" id="cancel-username-btn" class="btn btn-secondary">
                                        <i data-lucide="x"></i>
                                        <span>Abbrechen</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Email -->
                        <div class="dashboard-card">
                            <h3><i data-lucide="mail" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i> E-Mail-Adresse</h3>
                            <div class="form-group">
                                <label>Aktuelle E-Mail-Adresse</label>
                                <div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--color-bg-secondary); border: 1px solid var(--color-border); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
                                    <strong id="current-email-display">Wird geladen...</strong>
                                </div>
                            </div>
                            <button type="button" id="edit-email-btn" class="btn btn-secondary" style="margin-bottom: var(--spacing-sm);">
                                <i data-lucide="edit"></i>
                                <span>E-Mail bearbeiten</span>
                            </button>
                            <form id="email-form" class="account-form" style="display: none;">
                                <div class="form-group">
                                    <label for="email">Neue E-Mail-Adresse</label>
                                    <input type="email" id="email" name="email" required 
                                           placeholder="ihre@email.de">
                                    <small class="form-help">Ihre E-Mail wird verschl√ºsselt gespeichert</small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save"></i>
                                        <span>Speichern</span>
                                    </button>
                                    <button type="button" id="cancel-email-btn" class="btn btn-secondary">
                                        <i data-lucide="x"></i>
                                        <span>Abbrechen</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Password Change -->
                        <div class="dashboard-card">
                            <h3><i data-lucide="lock" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i> Passwort √§ndern</h3>
                            <form id="password-form" class="account-form">
                                <div class="form-group">
                                    <label for="current-password">Aktuelles Passwort</label>
                                    <input type="password" id="current-password" name="currentPassword" required 
                                           placeholder="Aktuelles Passwort eingeben"
                                           autocomplete="current-password">
                                </div>
                                <div class="form-group">
                                    <label for="new-password">Neues Passwort</label>
                                    <input type="password" id="new-password" name="newPassword" required 
                                           placeholder="Neues Passwort eingeben"
                                           minlength="8"
                                           autocomplete="new-password">
                                    <div id="password-strength" class="password-strength"></div>
                                    <small class="form-help">Mindestens 8 Zeichen</small>
                                </div>
                                <div class="form-group">
                                    <label for="confirm-password">Passwort best√§tigen</label>
                                    <input type="password" id="confirm-password" name="confirmPassword" required 
                                           placeholder="Neues Passwort best√§tigen"
                                           minlength="8"
                                           autocomplete="new-password">
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="generate-password-btn" class="btn btn-secondary">
                                        <i data-lucide="refresh-cw"></i>
                                        <span>Generieren</span>
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save"></i>
                                        <span>√Ñndern</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Display Name -->
                        <div class="dashboard-card">
                            <h3><i data-lucide="id-card" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i> Anzeigename</h3>
                            <form id="displayname-form" class="account-form">
                                <div class="form-group">
                                    <label for="display-name">Anzeigename</label>
                                    <input type="text" id="display-name" name="displayName" required 
                                           placeholder="Ihr Name"
                                           maxlength="50">
                                    <small class="form-help">Maximal 50 Zeichen</small>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i data-lucide="save"></i>
                                    <span>Anzeigename speichern</span>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Appearance Settings -->
                        <div class="dashboard-card">
                            <h3><i data-lucide="palette" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i> Darstellung</h3>
                            <div class="dark-mode-toggle-wrapper">
                                <div class="dark-mode-info">
                                    <h4>Dark Mode</h4>
                                    <p>Wechseln Sie zwischen hellem und dunklem Design</p>
                                </div>
                                <button type="button" id="dark-mode-toggle" class="dark-mode-toggle-btn">
                                    <i data-lucide="moon"></i>
                                    <span class="toggle-text">Dark Mode</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <footer class="dashboard-footer">
                <p>&copy; 2025 Iownme. Alle Rechte vorbehalten.</p>
            </footer>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
    
    <script src="../js/auth.js"></script>
    <script src="../js/permissions.js"></script>
    <script src="../js/darkmode.js"></script>
    <script src="../js/password-toggle.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/account.js"></script>
    <script>
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            const authStatus = await Auth.checkAuthStatus();
            
            if (!authStatus.authenticated) {
                window.location.href = '/';
                return;
            }
            
            Auth.startSessionValidation();
            
            const user = authStatus.user;
            const sidebarUsernameDisplay = document.getElementById('sidebar-username-display');
            
            if (sidebarUsernameDisplay && user) {
                sidebarUsernameDisplay.textContent = user.username;
            }
            
            // Initialize permission-based UI elements
            if (typeof Permissions !== 'undefined') {
                Permissions.initializeUI();
            }
            
            // Logout functionality
            const sidebarLogoutButton = document.getElementById('sidebar-logout-button');
            if (sidebarLogoutButton) {
                sidebarLogoutButton.addEventListener('click', async function() {
                    await Auth.logout();
                });
            }
            
            // Initialize Lucide icons
            lucide.createIcons();
        });
    </script>
</body>
</html>
